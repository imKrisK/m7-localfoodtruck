<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Member Profile</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
</head>
<body>
  <header class="head redesigned-header">
    <button id="mobile-menu-btn" aria-label="Open navigation" class="mobile-menu-btn">
      <i class="fas fa-bars"></i>
    </button>
    <div class="logo-title redesigned-logo-title">
      <img src="src/assets/LFTlogo.png" alt="Food Truck Logo" class="logo-img redesigned-logo-img" />
      <h1 class="site-title">Local Food <span class="brand-highlight"><i class="fas fa-truck"></i></span> Truck</h1>
    </div>
    <nav class="navbar redesigned-navbar" aria-label="Main Navigation">
      <ul id="nav-list" class="redesigned-nav-list">
        <li><a href="index.html#home" class="nav-link">Home</a></li>
        <li><a href="index.html#menu" class="nav-link">Menu</a></li>
        <li><a href="index.html#about" class="nav-link">About Us</a></li>
        <li><a href="index.html#contact" class="nav-link">Contact Us</a></li>
        <li id="nav-login"><a href="login.html" class="nav-link">Login</a></li>
        <li id="nav-register"><a href="registration.html" class="nav-link">Register</a></li>
        <li id="nav-profile" style="display:none"><a href="profile.html" class="nav-link">Profile</a></li>
        <li id="nav-logout" style="display:none"><a href="#" class="nav-link">Logout</a></li>
      </ul>
    </nav>
  </header>
  <div id="specials-banner" style="background:#fffbe6;border:1.5px solid #f95b11;color:#b85c00;padding:12px 18px;margin:24px 0 0 0;border-radius:8px;display:flex;align-items:center;gap:12px;font-size:1.08em;">
    <i class="fas fa-bullhorn" style="color:#f95b11;font-size:1.3em;"></i>
    <span><b>Today's Special:</b> <span id="specials-text">Spicy Wagyu Burger - $15.00! Limited time only. <a href="index.html#specials" style="color:#f95b11;text-decoration:underline;">See all specials</a></span></span>
  </div>
  <div class="profile-container">
    <h2 style="text-align:center">Member Profile</h2>
    <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:24px;">
      <img id="profile-avatar" src="src/assets/LFTlogo.png" alt="avatar" class="profile-avatar" />
      <input type="file" id="avatar-input" accept="image/*" style="margin-bottom:12px;" />
    </div>
   
    <div id="profile-favorites" style="margin-top:32px;">
      <h3>Your Favorites</h3>
      <div id="profile-favorites-list"></div>
    </div>
    <div id="profile-receipt" style="margin-top:32px;">
      <h3>Last Receipt <a href="receipt.html" style="font-size:0.7em;float:right;">View Full</a></h3>
      <ul id="profile-receipt-list" class="order-list"></ul>
      <div id="profile-receipt-total" class="order-total"></div>
      <div id="profile-order-id" style="color:#888;margin:8px 0 0 0;"></div>
    </div>
    <div id="order-history-section" style="margin-top:32px;">
      <h3>Order History</h3>
      <div id="order-history-list"></div>
    </div>
    <div id="push-section" style="margin-top:32px;text-align:center;">
      <button id="push-btn" class="form-btn" style="background:#007BFF;color:#fff;">Remind Me About Truck Specials</button>
      <div id="push-msg" style="margin-top:8px;color:#28a745;"></div>
    </div>
    <div id="find-us-section" style="margin-top:32px;">
      
      <button id="show-location-btn" class="form-btn" style="margin-bottom:12px;">Find our Food Truck</button>
      <div id="map" style="width:100%;height:300px;border-radius:8px;overflow:hidden;background:#f7f7f7;text-align:center;line-height:300px;color:#888;font-size:1.1em;">Map will appear here</div>
    </div>
    <section class="specials" id="profile-specials" style="max-width:900px;margin:40px auto 0 auto;padding:24px 0;">
      <div class="specials-content" style="display:flex;justify-content:center;align-items:center;">
        <div class="special-card" style="background:#fff;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,0.08);padding:24px 32px;max-width:340px;width:100%;align-items:center;">
          <div class="special-card-inner" style="position:relative;text-align:center;display:flex;flex-direction:column;align-items:center;">
            <img src="src/assets/LFTlogo.png" alt="Food Truck Logo" style="position:absolute;top:8px;right:8px;width:36px;height:36px;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.10);background:#fff;z-index:2;" />
            <img id="profile-specials-rotating-img" src="src/assets/burger.png" alt="Special" style="width:160px;height:100px;max-width:100%;object-fit:cover;border-radius:8px;transition:opacity 0.5s;display:block;margin:0 auto;position:relative;z-index:1;" />
           
            <!-- Move Today's Special below the image, centered -->
            <div style="width:100%;display:flex;justify-content:center;align-items:center;margin-top:12px;">
              <h4 style="background:var(--clr1);padding:4px 18px 2px 18px;border-radius:16px;font-size:1.08em;margin:0;box-shadow:0 2px 8px rgba(0,0,0,0.07);letter-spacing:0.5px;font-weight:600;color:#111;display:inline-block;">Today's Special</h4>
            </div>
            <h3 id="profile-specials-rotating-title" style="margin-top:18px;">Spicy Wagyu Burger</h3>
            <p id="profile-specials-rotating-desc" style="color:#111;">Limited time! Served with fries and a drink.</p>
            <span id="profile-specials-rotating-price" class="special-price" style="margin-bottom:8px;">$15.00</span>
            <form id="profile-specials-add-to-cart-form" style="margin-top:16px;display:flex;justify-content:center;align-items:center;gap:8px;width:100%;max-width:220px;">
              <input type="number" name="quantity" min="1" value="1" style="width:60px;">
              <button class="btn" type="submit" style="flex:1;min-width:0;">Add to Cart <i class="fas fa-plus-circle"></i></button>
            </form>
          </div>
        </div>
      </div>
    </section>
  </div>
  <script src="cart.js"></script>
  <script>
    
    // --- Auth Check ---
    // Do NOT clear memberProfile, orderHistory, or lastOrder on logout or login redirect
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'login.html';
    }
    // --- Profile State Management ---
    // Fix: define form, editBtn, profileView, nameInput, emailInput, avatarImg at the top
const form = document.querySelector('.profile-form') || document.querySelector('form');
const editBtn = document.getElementById('edit-btn');
const profileView = document.getElementById('profile-view');
const nameInput = document.getElementById('name') || document.querySelector('input[name="name"]');
const emailInput = document.getElementById('email') || document.querySelector('input[name="email"]');
const avatarImg = document.getElementById('profile-avatar');
// Fix: define passwordInput and viewName/viewEmail for profile logic
const passwordInput = document.getElementById('password') || document.querySelector('input[name="password"]');
const viewName = document.getElementById('view-name');
const viewEmail = document.getElementById('view-email');
// Remove per-user localStorage for profile/order history; always fetch from MongoDB when logged in
async function fetchProfileFromMongo() {
  // Use the email from the session/global memberProfile
  const globalProfile = JSON.parse(localStorage.getItem('memberProfile') || '{}');
  if (!globalProfile || !globalProfile.email) return null;
  try {
    const res = await fetch(`http://localhost:5380/users/by-email?email=${encodeURIComponent(globalProfile.email)}`);
    if (!res.ok) return null;
    return await res.json();
  } catch {
    return null;
  }
}
async function fetchOrderHistoryFromMongo() {
  const globalProfile = JSON.parse(localStorage.getItem('memberProfile') || '{}');
  if (!globalProfile || !globalProfile.email) return [];
  try {
    const res = await fetch(`http://localhost:5380/orders?userEmail=${encodeURIComponent(globalProfile.email)}`);
    if (!res.ok) return [];
    const orders = await res.json();
    return Array.isArray(orders) ? orders : [];
  } catch {
    return [];
  }
}
// --- On Page Load ---
window.addEventListener('DOMContentLoaded', async function() {
  // Always fetch profile and order history from MongoDB
  let loadedProfile = await fetchProfileFromMongo();
  if (!loadedProfile || !loadedProfile._id || !loadedProfile.email) {
    loadedProfile = {};
  }
  // Set global memberProfile for navigation, etc.
  localStorage.setItem('memberProfile', JSON.stringify(loadedProfile));
  loadProfile();
  // If profile exists, show view mode
  const profile = getProfile();
  // Defensive: Only set style if element exists
  if (form) form.style.display = profile.name || profile.email ? 'none' : '';
  if (editBtn) editBtn.style.display = profile.name || profile.email ? '' : 'none';
  if (profileView) profileView.style.display = profile.name || profile.email ? '' : 'none';
  renderProfileFavorites();
  renderProfileReceipt();
  renderOrderHistory();
  renderProfileCartSummary();
  // Show browser notification for specials if permission granted
  if ('Notification' in window && Notification.permission === 'granted') {
    setTimeout(() => {
      new Notification('Today\'s Special!', {
        body: 'Spicy Wagyu Burger - $15.00! Limited time only.',
        icon: 'src/assets/burger.png'
      });
    }, 2000);
  }
  // Ensure cart UI is updated and visible for new users
  if (typeof updateCartUI === 'function') updateCartUI();
  // Optionally, show cart toggle button for new users
  const cartToggleBtn = document.getElementById('cart-toggle-btn');
  // Defensive: Only set style if element exists
  if (cartToggleBtn) cartToggleBtn.style.display = '';
});
    // Rotating specials logic for profile page
    var profileSpecials = [
      {
        img: 'src/assets/burger.png',
        title: 'Spicy Wagyu Burger',
        desc: 'Limited time! Served with fries and a drink.',
        price: '$15.00'
      },
      {
        img: 'src/assets/bbq-porkchop.png',
        title: 'BBQ Porkchop Plate',
        desc: 'Char-grilled porkchop with house BBQ sauce.',
        price: '$14.00'
      },
      {
        img: 'src/assets/burrito1.png',
        title: "Wally's Special Burrito",
        desc: 'Loaded with beef, beans, and cheese. Only today!',
        price: '$12.00'
      }
    ];
    var profileSpecialIdx = 0;
    function showProfileSpecial(idx) {
      const img = document.getElementById('profile-specials-rotating-img');
      const title = document.getElementById('profile-specials-rotating-title');
      const desc = document.getElementById('profile-specials-rotating-desc');
      const price = document.getElementById('profile-specials-rotating-price');
      if (!img || !title || !desc || !price) return;
      img.style.opacity = 0;
      setTimeout(() => {
        img.src = profileSpecials[idx].img;
        title.textContent = profileSpecials[idx].title;
        desc.textContent = profileSpecials[idx].desc;
        price.textContent = profileSpecials[idx].price;
        img.style.opacity = 1;
      }, 300);
    }
    setInterval(() => {
      profileSpecialIdx = (profileSpecialIdx + 1) % profileSpecials.length;
      showProfileSpecial(profileSpecialIdx);
    }, 4000);
    window.addEventListener('DOMContentLoaded', () => showProfileSpecial(0));
    var profileSpecialsAddToCartForm = document.getElementById('profile-specials-add-to-cart-form');
    if (profileSpecialsAddToCartForm) {
      profileSpecialsAddToCartForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const quantity = parseInt(profileSpecialsAddToCartForm.querySelector('input[name="quantity"]').value, 10) || 1;
        const itemName = document.getElementById('profile-specials-rotating-title').textContent;
        const price = document.getElementById('profile-specials-rotating-price').textContent;
        if (typeof window.addToCart === 'function') {
          window.addToCart(itemName, price, quantity);
        } else {
          alert('Cart is not available.');
        }
      });
    }
    // --- Logout ---
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.onclick = function() {
        localStorage.removeItem('isLoggedIn');
        window.location.href = 'login.html';
      };
    }
    // --- Favorites in Profile ---
    // --- Render Favorites Section in Profile ---
function renderProfileFavorites() {
  const FAVORITES_KEY = 'menuFavorites';
  const menuItems = [
    { name: 'Waggu Burger', image: 'src/assets/burger.png', price: '$20.00' },
    { name: 'BBQ Porkchop', image: 'src/assets/bbq-porkchop.png', price: '$20.00' },
    { name: 'The Other Burrito', image: 'src/assets/burrito1.png', price: '$20.00' },
    { name: 'The Cal Burger Zone', image: 'src/assets/calburgerzone.png', price: '$20.00' },
    { name: 'The Burr', image: 'src/assets/burrito.png', price: '$20.00' },
    { name: 'Spare Ribs', image: 'src/assets/spare-ribs.png', price: '$20.00' },
    { name: 'chicken Wings', image: 'src/assets/chickenwings.png', price: '$20.00' },
    { name: 'QT!', image: 'src/assets/4lbsburger.png', price: '$20.00' },
    { name: 'Trifecta!', image: 'src/assets/comb3.png', price: '$20.00' }
  ];
  function getFavorites() {
    try {
      return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || [];
    } catch {
      return [];
    }
  }
  function setFavorites(favs) {
    localStorage.setItem(FAVORITES_KEY, JSON.stringify(favs));
  }
  const favorites = getFavorites();
  const favoritesList = document.getElementById('profile-favorites-list');
  favoritesList.innerHTML = '';
  if (favorites.length === 0) {
    favoritesList.innerHTML = '<p style="color:#888">No favorites yet. Go to the menu and click the heart to add some!</p>';
    return;
  }
  favorites.forEach(name => {
    const item = menuItems.find(m => m.name.trim().toLowerCase() === name.trim().toLowerCase());
    if (item) {
      const ratingKey = `menuRating_${item.name}`;
      const rating = parseInt(localStorage.getItem(ratingKey), 10) || 5;
      let starsHtml = '';
      for (let i = 1; i <= 5; i++) {
        starsHtml += `<i class=\"fas fa-star\" style=\"color:${i <= rating ? '#FFD700' : '#ccc'};font-size:1.1em;\"></i>`;
      }
      const box = document.createElement('div');
      box.className = 'in-box';
      box.style.maxWidth = '180px';
      box.style.display = 'inline-block';
      box.style.margin = '8px';
      box.innerHTML = `
        <img src="${item.image}" alt="${item.name}" class="veg-icon" style="width:60px;height:60px;object-fit:cover;">
        <div class="in-content">
          <div class="star" style="margin-bottom:4px;">${starsHtml}</div>
          <h2 style="font-size:1em;margin:8px 0 4px 0;">${item.name}</h2>
          <div class="price" style="font-size:0.95em;">${item.price}</div>
          <button class='remove-fav-btn' style='margin-top:8px;background:#d9534f;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;' data-name="${item.name}"><i class='fas fa-heart-broken'></i> Remove</button>
        </div>
      `;
      favoritesList.appendChild(box);
    }
  });
  // Add event listeners for remove buttons
  favoritesList.querySelectorAll('.remove-fav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const nameToRemove = btn.getAttribute('data-name');
      let favs = getFavorites();
      favs = favs.filter(f => f.trim().toLowerCase() !== nameToRemove.trim().toLowerCase());
      setFavorites(favs);
      renderProfileFavorites();
    });
  });
}
    // --- Receipt in Profile ---
    function renderProfileReceipt() {
      let order = {};
      try {
        order = JSON.parse(localStorage.getItem('lastOrder')) || {};
      } catch (e) { order = {}; }
      const items = order.items || [];
      const orderId = order.orderId || '';
      const receiptList = document.getElementById('profile-receipt-list');
      const receiptTotal = document.getElementById('profile-receipt-total');
      const orderIdDiv = document.getElementById('profile-order-id');
      receiptList.innerHTML = '';
      let total = 0;
      items.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${item.item} x${item.quantity}</span><span>${item.price}</span>`;
        receiptList.appendChild(li);
        const priceNum = parseFloat(item.price.replace(/[^\d.]/g, ''));
        total += priceNum * item.quantity;
      });
      receiptTotal.textContent = items.length ? 'Total: $' + total.toFixed(2) : '';
      orderIdDiv.textContent = orderId ? 'Order ID: ' + orderId : '';
      if (items.length === 0) {
        receiptList.innerHTML = '<li style="color:#888">No recent orders.</li>';
      }
    }
    // --- Fetch and Render Order History from MongoDB for Logged-in Users ---
    async function renderOrderHistory() {
      let orderHistory = [];
      if (localStorage.getItem('isLoggedIn') === 'true') {
        orderHistory = await fetchOrderHistoryFromMongo();
      }
      const listDiv = document.getElementById('order-history-list');
      listDiv.innerHTML = '';
      if (!orderHistory || orderHistory.length === 0) {
        listDiv.innerHTML = '<p style="color:#888">No past orders yet.</p>';
        return;
      }
      orderHistory.slice().reverse().forEach(order => {
        let total = 0;
        order.items.forEach(item => {
          const priceNum = parseFloat(item.price ? String(item.price).replace(/[^\d.]/g, '') : 0);
          total += priceNum * item.quantity;
        });
        const orderDiv = document.createElement('div');
        orderDiv.style = 'border:1px solid #eee;padding:12px;margin-bottom:16px;border-radius:8px;background:#fafafa;';
        orderDiv.innerHTML = `
          <div style='font-size:1.1em;margin-bottom:4px;'><b>Date:</b> ${order.date ? new Date(order.date).toLocaleString() : ''}</div>
          <div style='font-size:1em;margin-bottom:4px;'><b>Order ID:</b> ${order.orderId || order._id || ''}</div>
          <ul style='list-style:none;padding:0;margin:0 0 8px 0;'>
            ${order.items.map(item => `<li style='display:flex;justify-content:space-between;'><span>${item.item || item.name} x${item.quantity}</span><span>${item.price}</span></li>`).join('')}
          </ul>
          <div style='font-weight:bold;'>Total: $${total.toFixed(2)}</div>
          <button class='share-btn form-btn' style='margin-top:8px;background:#f95b11;color:#fff;' data-orderid='${order.orderId || order._id || ''}'>Share Order</button>
        `;
        listDiv.appendChild(orderDiv);
      });
      // Social sharing for each order
      Array.from(document.getElementsByClassName('share-btn')).forEach(btn => {
        btn.onclick = function() {
          const orderDiv = btn.parentElement;
          const text = orderDiv.innerText.replace(/\n+/g, '\n');
          if (navigator.share) {
            navigator.share({
              title: 'My Food Truck Order',
              text: text,
              url: window.location.href
            });
          } else {
            navigator.clipboard.writeText(text);
            alert('Order details copied to clipboard!');
          }
        };
      });
    }
    // --- Push Notification Opt-in ---
    document.getElementById('push-btn').onclick = function() {
      if (!('Notification' in window)) {
        document.getElementById('push-msg').textContent = 'Notifications not supported.';
        return;
      }
      Notification.requestPermission().then(function(permission) {
        if (permission === 'granted') {
          document.getElementById('push-msg').textContent = 'You will be reminded about truck specials!';
          setTimeout(() => {
            new Notification('Food Truck Special!', {
              body: 'Check out today\'s specials at your favorite food truck! 🚚🍔',
              icon: 'src/assets/LFTlogo.png'
            });
          }, 5000);
        } else {
          document.getElementById('push-msg').textContent = 'Notifications not enabled.';
        }
      });
    };
    // --- Mobile Restaurant Geolocation Feature ---
    document.getElementById('show-location-btn').onclick = function() {
      // Show only the food truck location (Las Vegas example)
      const truckLat = 36.1699;
      const truckLng = -115.1398;
      const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${truckLng-0.01},${truckLat-0.01},${truckLng+0.01},${truckLat+0.01}&layer=mapnik&marker=${truckLat},${truckLng}`;
      document.getElementById('map').innerHTML = `
        <iframe width="100%" height="300" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"
          src="${mapUrl}"></iframe>
        <div style="font-size:0.95em;margin-top:8px;text-align:left;padding:0 8px;">
          <b>Truck Location:</b> ${truckLat}, ${truckLng}
        </div>
      `;
    };
    // --- END Mobile Restaurant Geolocation ---
    // --- Modern mobile menu toggle ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const navList = document.getElementById('nav-list');
    if (mobileMenuBtn && navList) {
      mobileMenuBtn.addEventListener('click', function() {
        navList.classList.toggle('active');
        document.body.classList.toggle('nav-open');
      });
      navList.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          navList.classList.remove('active');
          document.body.classList.remove('nav-open');
        });
      });
    }
    // --- NAVBAR LOGIN/LOGOUT/PROFILE DYNAMIC ---
    function updateNavbarAuth() {
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      document.getElementById('nav-login').style.display = isLoggedIn ? 'none' : '';
      document.getElementById('nav-register').style.display = isLoggedIn ? 'none' : '';
      document.getElementById('nav-profile').style.display = isLoggedIn ? '' : 'none';
      document.getElementById('nav-logout').style.display = isLoggedIn ? '' : 'none';
    }
    document.getElementById('nav-logout').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('isLoggedIn');
      window.location.href = 'login.html';
    });
    updateNavbarAuth();
    // --- END NAVBAR DYNAMIC ---
    // --- On Page Load ---
    window.addEventListener('DOMContentLoaded', async function() {
      // Always fetch profile and order history from MongoDB
      let loadedProfile = await fetchProfileFromMongo();
      if (!loadedProfile || !loadedProfile._id || !loadedProfile.email) {
        loadedProfile = {};
      }
      // Set global memberProfile for navigation, etc.
      localStorage.setItem('memberProfile', JSON.stringify(loadedProfile));
      loadProfile();
      // If profile exists, show view mode
      const profile = getProfile();
      // Defensive: Only set style if element exists
      if (form) form.style.display = profile.name || profile.email ? 'none' : '';
      if (editBtn) editBtn.style.display = profile.name || profile.email ? '' : 'none';
      if (profileView) profileView.style.display = profile.name || profile.email ? '' : 'none';
      renderProfileFavorites();
      renderProfileReceipt();
      renderOrderHistory();
      renderProfileCartSummary();
      // Show browser notification for specials if permission granted
      if ('Notification' in window && Notification.permission === 'granted') {
        setTimeout(() => {
          new Notification('Today\'s Special!', {
            body: 'Spicy Wagyu Burger - $15.00! Limited time only.',
            icon: 'src/assets/burger.png'
          });
        }, 2000);
      }
      // Ensure cart UI is updated and visible for new users
      if (typeof updateCartUI === 'function') updateCartUI();
      // Optionally, show cart toggle button for new users
      const cartToggleBtn = document.getElementById('cart-toggle-btn');
      // Defensive: Only set style if element exists
      if (cartToggleBtn) cartToggleBtn.style.display = '';
    });
    // Rotating specials logic for profile page
    var profileSpecials = [
      {
        img: 'src/assets/burger.png',
        title: 'Spicy Wagyu Burger',
        desc: 'Limited time! Served with fries and a drink.',
        price: '$15.00'
      },
      {
        img: 'src/assets/bbq-porkchop.png',
        title: 'BBQ Porkchop Plate',
        desc: 'Char-grilled porkchop with house BBQ sauce.',
        price: '$14.00'
      },
      {
        img: 'src/assets/burrito1.png',
        title: "Wally's Special Burrito",
        desc: 'Loaded with beef, beans, and cheese. Only today!',
        price: '$12.00'
      }
    ];
    var profileSpecialIdx = 0;
    function showProfileSpecial(idx) {
      const img = document.getElementById('profile-specials-rotating-img');
      const title = document.getElementById('profile-specials-rotating-title');
      const desc = document.getElementById('profile-specials-rotating-desc');
      const price = document.getElementById('profile-specials-rotating-price');
      if (!img || !title || !desc || !price) return;
      img.style.opacity = 0;
      setTimeout(() => {
        img.src = profileSpecials[idx].img;
        title.textContent = profileSpecials[idx].title;
        desc.textContent = profileSpecials[idx].desc;
        price.textContent = profileSpecials[idx].price;
        img.style.opacity = 1;
      }, 300);
    }
    setInterval(() => {
      profileSpecialIdx = (profileSpecialIdx + 1) % profileSpecials.length;
      showProfileSpecial(profileSpecialIdx);
    }, 4000);
    window.addEventListener('DOMContentLoaded', () => showProfileSpecial(0));
    var profileSpecialsAddToCartForm = document.getElementById('profile-specials-add-to-cart-form');
    if (profileSpecialsAddToCartForm) {
      profileSpecialsAddToCartForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const quantity = parseInt(profileSpecialsAddToCartForm.querySelector('input[name="quantity"]').value, 10) || 1;
        const itemName = document.getElementById('profile-specials-rotating-title').textContent;
        const price = document.getElementById('profile-specials-rotating-price').textContent;
        if (typeof window.addToCart === 'function') {
          window.addToCart(itemName, price, quantity);
        } else {
          alert('Cart is not available.');
        }
      });
    }
    // --- Save Profile ---
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const avatar = avatarImg.src;
      try {
        var currentProfile = JSON.parse(localStorage.getItem('memberProfile') || '{}');
        let res;
        if (currentProfile && currentProfile._id) {
          res = await fetch(`http://localhost:5380/users/${currentProfile._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password, avatar })
          });
        } else {
          res = await fetch('http://localhost:5380/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password, avatar })
          });
        }
        if (!res.ok) {
          alert('Profile update failed.');
          return;
        }
        const updated = await res.json();
        localStorage.setItem('memberProfile', JSON.stringify(updated));
        loadProfile();
        form.style.display = 'none';
        editBtn.style.display = '';
        profileView.style.display = '';
      } catch (err) {
        alert('Network error. Please try again.');
      }
    });

    function loadProfile() {
  const profile = JSON.parse(localStorage.getItem('memberProfile') || '{}');
  if (profile.avatar && avatarImg) avatarImg.src = profile.avatar;
  else if (avatarImg) avatarImg.src = 'src/assets/LFTlogo.png';
  if (nameInput) nameInput.value = profile.name || '';
  if (emailInput) emailInput.value = profile.email || '';
  if (passwordInput) passwordInput.value = '';
  if (viewName) viewName.textContent = profile.name || '-';
  if (viewEmail) viewEmail.textContent = profile.email || '-';
}
    // --- Listen for favorites change and update profile favorites live ---
window.addEventListener('storage', function(e) {
  if (e.key === 'menuFavorites') {
    renderProfileFavorites();
  }
});
// Also update favorites when returning to the profile page
window.addEventListener('focus', renderProfileFavorites);
// --- Add missing getProfile helper ---
function getProfile() {
  try {
    return JSON.parse(localStorage.getItem('memberProfile')) || {};
  } catch {
    return {};
  }
}
    // --- Shopping Cart UI in Profile Card ---
function renderProfileCartSummary() {
  // Remove old cart summary if present
  const oldSummary = document.getElementById('profile-cart-summary');
  if (oldSummary) oldSummary.remove();
  let cart = [];
  try {
    cart = JSON.parse(localStorage.getItem('checkoutCart')) || [];
  } catch { cart = []; }
  if (!cart.length) return;
  let subtotal = 0;
  cart.forEach(item => {
    const priceNum = parseFloat((item.price||'').toString().replace(/[^\d.]/g, ''));
    subtotal += priceNum * (item.quantity || 1);
  });
  const taxRate = 0.0825;
  const tax = subtotal * taxRate;
  const total = subtotal + tax;
  const summaryDiv = document.createElement('div');
  summaryDiv.id = 'profile-cart-summary';
  summaryDiv.style = 'background:#f7f7f7;padding:12px 10px 10px 10px;border-radius:8px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);font-size:1em;position:absolute;bottom:16px;right:16px;min-width:180px;z-index:10;';
  summaryDiv.innerHTML =
    `<div style='font-weight:bold;margin-bottom:4px;'>Cart Summary</div>` +
    `<div>Subtotal: $${subtotal.toFixed(2)}</div>` +
    `<div>Tax (8.25%): $${tax.toFixed(2)}</div>` +
    `<div style='font-weight:bold;'>Total: $${total.toFixed(2)}</div>`;
  // Place inside the card, above Place Order button if present
  const card = document.querySelector('.special-card-inner');
  if (card) {
    card.style.position = 'relative';
    const placeOrderBtn = card.querySelector('.btn[type="submit"]');
    if (placeOrderBtn) {
      card.insertBefore(summaryDiv, placeOrderBtn);
    } else {
      card.appendChild(summaryDiv);
    }
  }
}
window.addEventListener('DOMContentLoaded', function() {
  renderProfileCartSummary();
});
// Also update cart summary when cart changes
window.addEventListener('storage', function(e) {
  if (e.key === 'checkoutCart') renderProfileCartSummary();
});
  </script>
</body>
</html>
