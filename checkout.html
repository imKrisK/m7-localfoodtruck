<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Food Truck</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body style="background: #fff url('./src/assets/LFTlogo.png') no-repeat top 40px center fixed; background-size: 120px auto;">
  <div class="checkout-container">
    <h2>Order Summary</h2>
    <form id="guest-info-form" autocomplete="off">
      <h3>Your Information (required for delivery)</h3>
      <input type="text" id="guest-name" name="guest-name" placeholder="Full Name" required>
      <input type="email" id="guest-email" name="guest-email" placeholder="Email (optional)">
      <input type="tel" id="guest-phone" name="guest-phone" placeholder="Phone (optional)">
      <textarea id="guest-address" name="guest-address" placeholder="Delivery Address" required></textarea>
      <button type="button" id="get-location-btn">Use My Current Location</button>
      <div id="map-preview"></div>
    </form>
    <ul id="order-list" class="order-list"></ul>
    <div id="order-total" class="order-total"></div>
    <div id="empty-message" class="empty" style="display:none;">Your cart is empty.</div>
    <div id="order-feedback" style="text-align:center;margin-top:10px;color:#d9534f;"></div>
    <button class="btn" id="place-order-btn" type="button">Place Order</button>
    <button class="btn" id="back-btn" style="background:#eee;color:#333;">Back to Menu</button>
  </div>
  <div id="order-confirm-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:32px 24px;border-radius:10px;max-width:420px;width:90vw;box-shadow:0 4px 24px rgba(0,0,0,0.18);position:relative;">
      <span id="close-confirm-modal" style="position:absolute;top:12px;right:18px;font-size:1.5em;cursor:pointer;">&times;</span>
      <div id="confirm-modal-content"></div>
      <div style="display:flex;gap:8px;margin-top:18px;">
        <button class="btn" id="confirm-print-btn" style="flex:1;background:#f95b11;color:#fff;">Print</button>
        <button class="btn" id="confirm-email-btn" style="flex:1;background:#28a745;color:#fff;">Email</button>
      </div>
      <button class="btn" id="view-receipt-btn" style="background:#007bff;color:#fff;margin-top:12px;">View Full Receipt</button>
    </div>
  </div>
  <script>
    function renderOrder() {
      const orderList = document.getElementById('order-list');
      const orderTotal = document.getElementById('order-total');
      const emptyMsg = document.getElementById('empty-message');
      let cart = [];
      try {
        cart = JSON.parse(localStorage.getItem('checkoutCart')) || [];
      } catch (e) { cart = []; }
      orderList.innerHTML = '';
      let subtotal = 0;
      if (cart.length === 0) {
        orderTotal.textContent = '';
        emptyMsg.style.display = 'block';
        document.getElementById('place-order-btn').disabled = true;
        return;
      }
      emptyMsg.style.display = 'none';
      document.getElementById('place-order-btn').disabled = false;
      cart.forEach(item => {
        const priceNum = parseFloat(item.price.replace(/[^\d.]/g, ''));
        const itemTotal = priceNum * item.quantity;
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.marginBottom = '6px';
        li.innerHTML = `
          <span style="flex:2;text-align:left;">${item.item} x${item.quantity}</span>
          <span style="flex:1;text-align:right;color:#f95b11;font-weight:600;">${item.price} ea</span>
          <span style="flex:1;text-align:right;margin-left:8px;">= $${itemTotal.toFixed(2)}</span>
        `;
        orderList.appendChild(li);
        subtotal += itemTotal;
      });
      const taxRate = 0.0825;
      const tax = subtotal * taxRate;
      const total = subtotal + tax;
      // Align price breakdown visually
      orderTotal.style.textAlign = 'right';
      orderTotal.style.marginTop = '12px';
      orderTotal.style.fontSize = '1.08em';
      orderTotal.innerHTML =
        `<div style='margin-bottom:2px;display:flex;justify-content:flex-end;'><span style='flex:1;text-align:right;'>Subtotal:</span> <span style='min-width:80px;display:inline-block;text-align:right;'>$${subtotal.toFixed(2)}</span></div>` +
        `<div style='margin-bottom:2px;display:flex;justify-content:flex-end;'><span style='flex:1;text-align:right;'>Tax (8.25%):</span> <span style='min-width:80px;display:inline-block;text-align:right;'>$${tax.toFixed(2)}</span></div>` +
        `<div style='font-weight:bold;display:flex;justify-content:flex-end;'><span style='flex:1;text-align:right;'>Total:</span> <span style='min-width:80px;display:inline-block;text-align:right;'>$${total.toFixed(2)}</span></div>`;
    }
    renderOrder();
    document.getElementById('place-order-btn').onclick = function() {
      const placeOrderBtn = document.getElementById('place-order-btn');
      const feedbackDiv = document.getElementById('order-feedback');
      feedbackDiv.style.color = '#333';
      feedbackDiv.textContent = 'Placing your order...';
      document.querySelector('.checkout-container').setAttribute('aria-busy', 'true');
      placeOrderBtn.disabled = true;
      const cart = JSON.parse(localStorage.getItem('checkoutCart')) || [];
      if (cart.length === 0) {
        feedbackDiv.style.color = '#d9534f';
        feedbackDiv.textContent = 'Your cart is empty!';
        placeOrderBtn.disabled = false;
        document.querySelector('.checkout-container').setAttribute('aria-busy', 'false');
        return;
      }
      // Guest info validation
      const name = document.getElementById('guest-name').value.trim();
      const email = document.getElementById('guest-email').value.trim();
      const phone = document.getElementById('guest-phone').value.trim();
      const address = document.getElementById('guest-address').value.trim();
      if (!name || !address) {
        feedbackDiv.style.color = '#d9534f';
        feedbackDiv.textContent = 'Please provide your name and delivery address.';
        document.getElementById('guest-name').focus();
        placeOrderBtn.disabled = false;
        document.querySelector('.checkout-container').setAttribute('aria-busy', 'false');
        return;
      }
      const guestInfo = { name, email, phone, address };
      // Optionally generate a simple order ID (timestamp-based)
      const orderId = 'ORD-' + Date.now();
      // Calculate totals (with tax)
      let subtotal = 0;
      cart.forEach(item => {
        const priceNum = parseFloat(item.price.replace(/[^\d.]/g, ''));
        subtotal += priceNum * item.quantity;
      });
      const taxRate = 0.0825;
      const tax = subtotal * taxRate;
      const total = subtotal + tax;
      // --- ENHANCEMENT: Add userId/email if logged in ---
      let userId = null;
      let userEmail = null;
      let userName = null;
      if (localStorage.getItem('isLoggedIn') === 'true') {
        try {
          const profile = JSON.parse(localStorage.getItem('memberProfile')) || {};
          userId = profile._id || null;
          userEmail = profile.email || null;
          userName = profile.name || null;
        } catch {}
      }
      // Save order details for receipt page
      const orderData = {
        items: cart,
        orderId,
        guestInfo,
        subtotal,
        tax,
        total,
        date: new Date().toISOString(),
        status: 'pending',
        userId,
        userEmail,
        userName
      };
      // --- POST order to backend (MongoDB) ---
      fetch('http://localhost:5380/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
      })
      .then(async res => {
        if (!res.ok) {
          let msg = 'Order could not be saved to server.';
          try { const data = await res.json(); if (data.error) msg = data.error; } catch {}
          throw new Error(msg);
        }
        return res.json();
      })
      .then(data => {
        // Save to order history in localStorage (fallback) only after backend success
        let orderHistory = [];
        try { orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || []; } catch { orderHistory = []; }
        orderHistory.push(orderData);
        localStorage.setItem('orderHistory', JSON.stringify(orderHistory));
        localStorage.removeItem('checkoutCart');
        localStorage.setItem('lastOrder', JSON.stringify(orderData));
        // Show confirmation modal
        showOrderConfirmationModal(orderData);
      })
      .catch(err => {
        feedbackDiv.style.color = '#d9534f';
        feedbackDiv.textContent = err.message || 'Order could not be saved to server. Please try again.';
        placeOrderBtn.disabled = false;
        document.querySelector('.checkout-container').setAttribute('aria-busy', 'false');
      });
    };
    document.getElementById('back-btn').onclick = function() {
      window.location.href = 'index.html#menu';
    };
    // --- Geolocation for Address Autofill and Map Preview ---
    document.getElementById('get-location-btn').onclick = function() {
      const mapDiv = document.getElementById('map-preview');
      mapDiv.style.display = 'block';
      mapDiv.innerHTML = 'Locating...';
      if (!navigator.geolocation) {
        mapDiv.innerHTML = 'Geolocation is not supported by your browser.';
        return;
      }
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          // Show map
          const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.01},${lat-0.01},${lng+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lng}`;
          mapDiv.innerHTML = `<iframe width='100%' height='180' frameborder='0' scrolling='no' marginheight='0' marginwidth='0' src='${mapUrl}'></iframe>`;
          // Use a reverse geocoding API for address autofill
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
              if (data && data.display_name) {
                document.getElementById('guest-address').value = data.display_name;
              } else {
                mapDiv.innerHTML += '<div style="color:#d9534f;">Unable to retrieve address from location.</div>';
              }
            })
            .catch(() => {
              mapDiv.innerHTML += '<div style="color:#d9534f;">Unable to retrieve address from location.</div>';
            });
        },
        function(error) {
          let msg = 'Unable to retrieve your location.';
          if (error.code === error.PERMISSION_DENIED) {
            msg = 'Location permission denied. Please allow location access.';
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            msg = 'Location information is unavailable.';
          } else if (error.code === error.TIMEOUT) {
            msg = 'Location request timed out.';
          }
          mapDiv.innerHTML = `<div style='color:#d9534f;'>${msg}</div>`;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    };
    // --- Confirmation Modal Logic ---
    function showOrderConfirmationModal(order) {
      const modal = document.getElementById('order-confirm-modal');
      const content = document.getElementById('confirm-modal-content');
      const items = order.items || [];
      let itemsHtml = '';
      items.forEach(item => {
        const priceNum = parseFloat(item.price.replace(/[^\d.]/g, ''));
        const itemTotal = priceNum * item.quantity;
        itemsHtml += `<li style='display:flex;justify-content:space-between;'><span>${item.item} x${item.quantity}</span><span>$${itemTotal.toFixed(2)}</span></li>`;
      });
      content.innerHTML = `
        <h3 style='margin-top:0;'>Order Placed!</h3>
        <div style='color:#28a745;margin-bottom:8px;'>Thank you for your order!</div>
        <div><b>Order ID:</b> ${order.orderId}</div>
        <ul style='list-style:none;padding:0;margin:10px 0;'>${itemsHtml}</ul>
        <div style='text-align:right;margin-bottom:4px;'>Subtotal: $${order.subtotal.toFixed(2)}</div>
        <div style='text-align:right;margin-bottom:4px;'>Tax: $${order.tax.toFixed(2)}</div>
        <div style='text-align:right;font-weight:bold;'>Total: $${order.total.toFixed(2)}</div>
        <div style='margin-top:10px;font-size:0.95em;color:#888;'>A receipt is available below and can be emailed or printed.</div>
      `;
      modal.style.display = 'flex';
      // Print
      document.getElementById('confirm-print-btn').onclick = function() {
        window.print();
      };
      // Email
      document.getElementById('confirm-email-btn').onclick = function() {
        const email = order.guestInfo && order.guestInfo.email ? order.guestInfo.email : '';
        const subject = encodeURIComponent('Your Food Truck Order Receipt');
        let body = `Order ID: ${order.orderId}\n`;
        order.items.forEach(item => {
          body += `${item.item} x${item.quantity}: $${(parseFloat(item.price.replace(/[^\d.]/g, '')) * item.quantity).toFixed(2)}\n`;
        });
        body += `Subtotal: $${order.subtotal.toFixed(2)}\nTax: $${order.tax.toFixed(2)}\nTotal: $${order.total.toFixed(2)}\n`;
        body += `\nThank you for your order!`;
        window.location.href = `mailto:${email}?subject=${subject}&body=${encodeURIComponent(body)}`;
      };
      // View Receipt
      document.getElementById('view-receipt-btn').onclick = function() {
        modal.style.display = 'none';
        window.location.href = 'receipt.html';
      };
      // Close modal
      document.getElementById('close-confirm-modal').onclick = function() {
        modal.style.display = 'none';
        window.location.href = 'receipt.html';
      };
    }
  </script>
</body>
</html>
